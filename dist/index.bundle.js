(()=>{"use strict";var e={256:(e,r,s)=>{s.r(r),s.d(r,{default:()=>V});const t=require("joi");var o=s.n(t);s(142).config();const n=o().object().keys({NODE_ENV:o().string().default("development").valid("development","production"),PORT:o().number().default(8080),VERSION:o().string(),MYSQL_HOST:o().string().default("127.0.0.1"),MYSQL_PORT:o().number().default(3306),MYSQL_USER:o().string(),MYSQL_PASS:o().string(),MYSQL_DATABASE:o().string()}).unknown().required(),{error:a,value:i}=n.validate(process.env);if(a)throw new Error(`Config validation error: ${a.message}`);const c={version:i.VERSION,env:i.NODE_ENV,port:i.PORT,mysql_host:i.MYSQL_HOST,mysql_port:i.MYSQL_PORT,mysql_user:i.MYSQL_USER,mysql_pass:i.MYSQL_PASS,mysql_database:i.MYSQL_DATABASE},d=require("express");var l=s.n(d);const u=require("mysql");var m=s.n(u);const _=require("morgan");var p=s.n(_);const h=s(344),y=m().createPool({connectionLimit:10,host:c.mysql_host,user:c.mysql_user,password:c.mysql_pass,database:c.mysql_database}),{Joi:g}=s(858),q={createArticle:{body:g.object({user_id:g.number().required(),article_title:g.string().required(),article_tag:g.string().required(),article_content:g.string().min(20).required()})},createUser:{body:g.object({user_name:g.string().required(),user_mail:g.string().email().trim().required(),user_password:g.string().regex(/[a-zA-Z0-9]{6,30}$/).required()})}},{validate:f}=s(858),S=l().Router();S.route("/").get(((e,r)=>{new Promise(((e,r)=>{y.getConnection(((s,t)=>{s?r(s):t.query("SELECT * FROM Article",((s,o)=>{s?(console.error("SQL error: ",s),r(s)):e(o),t.release()}))}))})).then((e=>{r.send(e)})).catch((e=>r.send(e)))})),S.post("/",f(q.createArticle,{},{}),((e,r)=>{(e=>new Promise(((r,s)=>{y.getConnection(((t,o)=>{t?s(t):o.query("INSERT INTO article SET ?",e,((e,s)=>{e?console.error("SQL error: ",e):1===s.affectedRows&&r(`新增成功 ! article_id: ${s.insertId}`),o.release()}))}))})))(e.body).then((e=>{r.send(e)})).catch((e=>r.send(e)))})),S.route("/:article_id").put(((e,r)=>{const s=e.params.article_id;((e,r)=>new Promise(((s,t)=>{y.getConnection(((o,n)=>{o?t(o):n.query("UPDATE Article SET ? WHERE article_id = ?",[e,r],((e,r)=>{e?(console.error("SQL error:",e),t(e)):0===r.affectedRows?s("check your user_id"):1===r.affectedRows?s("success !"):s("No change"),n.release()}))}))})))(e.body,s).then((e=>{r.send(e)})).catch((e=>{r.send(e)}))})),S.route("/:article_id").delete(((e,r)=>{(e=>new Promise(((r,s)=>{y.getConnection(((t,o)=>{t?s(t):o.query("DELETE FROM Article WHERE article_id = ?",e,((e,s)=>{e?console.error("sql error : ",e):1===s.affectedRows?r("success !"):r("no change"),o.release()}))}))})))(e.params.article_id).then((e=>{r.send(e)})).catch((e=>{r.send(e)}))})),S.get("/personal",((e,r,s)=>{const t=e.headers.authorization;if(void 0!==t){const r=t.split(" ")[1];e.token=r,s()}else r.status(403).send(Object.assign({code:403},{message:"您尚未登入"}))}),((e,r)=>{var s;(s=e.token,new Promise(((e,r)=>{h.verify(s,"my_secret_key",((s,t)=>{if(s)r(s);else{const s=t.payload.user_id;y.getConnection(((t,o)=>{t?r(t):o.query("select * from article where user_id=?",[s],((s,t)=>{s?r(s):e(t),o.release()}))}))}}))}))).then((e=>{r.send(e)})).catch((e=>r.status(401).send(e)))}));const b=S,w=require("bcrypt");var v=s.n(w);const E=require("http-status");var O=s.n(E);class P extends Error{constructor(e,r,s,t){super(e),this.message=e,this.name=this.constructor.name,this.status=r,this.isPublic=s,this.code=t,this.isOperational=!0,Error.captureStackTrace(this,this.constructor)}}const R=class extends P{constructor(e="信箱尚未註冊!",r=O().NOT_FOUND,s=!0,t=401){super(e,r,s,t),this.name="LoginError"}},T=class extends P{constructor(e="輸入的密碼有誤",r=O().NOT_FOUND,s=!0,t=401){super(e,r,s,t),this.name="LoginError"}},x=s(344),L=m().createPool({connectionLimit:10,host:c.mysql_host,user:c.mysql_user,password:c.mysql_pass,database:c.mysql_database}),{validate:M,ValidationError:j}=s(858),A=l().Router();A.post("/",M(q.createUser,{},{}),((e,r)=>{const s=v().genSaltSync(10);(e=>new Promise(((r,s)=>{L.getConnection(((t,o)=>{t?s(t):o.query("INSERT INTO User SET ?",e,((e,t)=>{e?(console.error(e),s("sql error :",e)):1===t.affectedRows?r("sucess !"):r("no change"),o.release()}))}))})))({user_name:e.body.user_name,user_mail:e.body.user_mail,user_password:v().hashSync(e.body.user_password,s)}).then((e=>{r.send(e)})).catch((e=>r.send(e)))})),A.route("/").get(((e,r)=>{new Promise(((e,r)=>{L.getConnection(((s,t)=>{s?r(s):t.query("select * from user",((s,o)=>{s?(console.error("sql err :",s),r("sql err :",s)):e(o),t.release()}))}))})).then((e=>{r.send(e)})).catch((e=>{r.send(e)}))})),A.route("/:user_id").put(((e,r)=>{const s=e.params.user_id;((e,r)=>new Promise(((s,t)=>{L.getConnection(((o,n)=>{o?t(o):n.query("update user set ? where user_id = ?",[e,r],((e,r)=>{e?(console.error("sql error :",e),t("sql error :",e)):0===r.affectedRows?s("check your userId"):s("success !"),n.release()}))}))})))(e.body,s).then((e=>{r.send(e)})).catch((e=>{r.send(e)}))})),A.route("/:user_id").delete(((e,r)=>{(e=>new Promise(((r,s)=>{L.getConnection(((t,o)=>{t?s(t):o.query("delete from user where user_id = ?",e,((e,t)=>{e?(console.error("sql error :",e),s(e)):1===t.affectedRows?r("sucess !"):r("no change"),o.release()}))}))})))(e.params.user_id).then((e=>{r.send(e)})).catch((e=>{r.send(e)}))})),A.route("/login").post(((e,r,s)=>{(e=>new Promise(((r,s)=>{L.getConnection(((t,o)=>{t?s(t):o.query("select * from user where user_mail=?",e.user_mail,((t,n)=>{if(t)console.error("sql error:",t),s("sql err",t);else if(0===Object.keys(n).length)s(new R);else{const t=n[0].user_password,o=e.user_password;v().compare(o,t).then((e=>{if(e){const e={user_id:n[0].user_id,user_name:n[0].user_name,user_mail:n[0].user_mail},s=x.sign({payload:e,exp:Math.floor(Date.now()/1e3)+900},"my_secret_key");r(Object.assign({code:200},{message:"登入成功",token:s}))}else s(new T)}))}o.release()}))}))})))(e.body).then((e=>{r.send(e)})).catch((e=>{s(e)}))}));const N=A,C=l().Router();C.get("/",((e,r)=>{r.send(`此路徑是: localhost:${c.port}/api`)})),C.get("/sqlTest",((e,r)=>{m().createPool({connectionLimit:10,host:c.mysql_host,user:c.mysql_user,password:c.mysql_pass,database:c.mysql_database}).getConnection(((e,s)=>{e?(r.send(e),console.log("連線失敗 !")):(r.send(s),console.log("連線成功 !"))}))})),C.use("/user",N),C.use("/article",b);const Q=C,k=require("body-parser");var Y=s.n(k);const D=require("cors");var U=s.n(D);const I=l()();I.use(Y().json()),I.use(Y().urlencoded({extended:!0})),I.use(U()()),I.use(p()("dev")),I.get("/",((e,r)=>{r.send(`server started on port http://127.0.0.1:${c.port} (${c.env})`)})),I.use("/api",Q);const $=I;(e=s.hmd(e)).parent||$.listen(c.port,(()=>{console.log(`server started on port http://127.0.0.1:${c.port} (${c.env})`)}));const V=$},142:e=>{e.exports=require("dotenv")},858:e=>{e.exports=require("express-validation")},344:e=>{e.exports=require("jsonwebtoken")}},r={};function s(t){var o=r[t];if(void 0!==o)return o.exports;var n=r[t]={id:t,loaded:!1,exports:{}};return e[t](n,n.exports,s),n.loaded=!0,n.exports}s.n=e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return s.d(r,{a:r}),r},s.d=(e,r)=>{for(var t in r)s.o(r,t)&&!s.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:r[t]})},s.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),s.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var t=s(256);module.exports=t})();